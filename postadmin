#!/bin/bash



###
## Functions

  ###
  ## Helpers

    show_help() {
      echo "
Usage: $0 [actions] [commands] [options] args...
       $0 [$actions] [$commands] [options] args...
"
    }

    require_var() {
      var="$1"
      if [ -z ${!var} ]; then
        echo -n "$var is not declared: "
        [ ! -z "$2" ] && echo "$2"
        exit 1
      fi
    }


    # Mysql queries
  
    domain_id() {
      $mysql "USE ${mysql_database}; SELECT id FROM virtual_domains WHERE name = '$1';"
    }

    email_id() {
      $mysql "USE ${mysql_database}; SELECT id FROM virtual_users WHERE email = '$1';"
    }

  ##
  ###
  
  
  
  ###
  ## Commands

    domain() {
      add() {
        echo "add"
      }
      show() {
        echo "show"
      }
      delete() {
        echo "delete"
      }
      update() {
        echo "Unimplemented"
        show_help
      }
      suspend() {
        echo "Unimplemented"
        show_help
      }
      "$1"
    }

    email() {
      add() {
        echo "add"
      }
      show() {
        echo "show"
      }
      delete() {
        echo "delete"
      }
      update() {
        echo "Unimplemented"
        show_help
      }
      suspend() {
        echo "Unimplemented"
        show_help
      }
      "$1"
    }

    alias() {
      add() {
        echo "add"
      }
      show() {
        echo "show"
      }
      delete() {
        echo "delete"
      }
      update() {
        echo "Unimplemented"
        show_help
      }
      suspend() {
        echo "Unimplemented"
        show_help
      }
      "$1"
    }
    
  ##
  ###

##
###



###
## Variables
 
  # Environment variables 
  declare -r POSTADM_CONF="${POSTADM_CONF:-/usr/local/etc/postadmin/postadmin.conf}"
  
  . "$POSTADM_CONF"

  # Script variables
  require_var 'mysql_passwd' "in $POSTADM_CONF"

  declare -r mysql_user="${mysql_user:-mailadmin}"
  declare -r mysql_host="${mysql_host:-localhost}"
  declare -r mysql_database="${mysql_database:-mailserver}"

  declare -r vmail_home="${vmail_home:-/var/vmail}"

  declare -r user_name_min_length="${user_name_min_length:-1}"
  declare -r user_name_max_length="${user_name_max_length:-23}"
  declare -r password_min_length="${password_min_length:-6}"

  declare -r actions="add|show|delete|update|suspend"
  declare -r commands="domain|email|alias"

  declare -r mysql="mysql -u${mysql_user} -p${mysql_passwd} -h${mysql_host} -ss -e"
  
##
###



###
## Parsing arguments

  # action
  if ! [[ "$1" =~ ^($actions)$ ]]; then
    echo "Unknow action $1"
    show_help
    exit 1
  fi

  declare -r action="$1"

  # command
  if ! [[ "$2" =~ ^($commands)$ ]]; then
      echo "Unknow command $2"
      show_help
      exit 1
  fi

  declare -r command="$2"

##
###



###
## Main

  "$command" "$action"

##
###

exit 0
